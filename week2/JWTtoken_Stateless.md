토큰 기반 인증은 서버의 무상태성(Stateless)를 유지하기 위한 시스템이다.
예전에 인프런에서 김영한 님의 HTTP 강의를 들었던 내용을 복기해보았다.

\*\* 추가: 아래 조사한 내용을 바탕으로 지난주 채용과제를 수정해보다가
조사 내용 관련하여 너무 잘 정리된 글을 발견하여 공유한다.

링크: https://naon.me/posts/til63

\*\* 추가: Refresh 토큰에 관해 정리가 매우 잘된 글도 발견하여 공유!
링크: https://han-um.tistory.com/17

무상태성
출처: https://www.notion.so/HTTP-80593ee053bb4186a42c7c62446f12a2?p=6d6e1b6827c748298de7578b58f361de

무상태성이란 서버가 클라이언트의 상태를 보존하지 않음을 의미한다.
(서버한테 '상태'가 없다는 뜻)

HTTP 서버는 기본적으로 무상태성(Stateless)을 지향한다.
왜? 서버를 무한 확장 가능하기 때문이다.
이는 고객이나 요청(트래픽)이 갑자기 증가할 때
서버를 추가하기가 쉬워진다는 의미이다.

무상태성이 아닐 경우엔 서버 하나가 장애가 나면
그 서버와 연결된 클라이언트가 작업을 처음부터 다시 해야 하는데
(예: 사이트 튕기면 결제 처음부터 다시 해야 하는 경우)

무상태성으로 클라이언트 쪽에서 고객 정보를 보관하면
서버에서 장애가 나도 다른 서버에서도 얼마든지 요청을 처리할 수 있다.

단점:
클라이언트가 서버한테 요청할 때 추가로 전송해야 할 정보가 늘어난다.
(요청할 때마다 매번 서버한테 자신의 상태를 알려주어야 함)

이렇게 payload가 커질 수 있기 때문에 모든 경우를 무상태성으로 설계하지는 않는다.

로그인이 필요없는 단순한 서비스 소개 화면이나,
로그인한 상태를 유지하기 위해 세션스토리지 등을 사용할 때는
서버에 상태를 저장하기도 한다.

JSON 토큰
출처: https://velog.io/@heumheum2/JWT-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%9D%B8%EC%A6%9D%EB%B0%A9%EC%8B%9D

JSON 토큰은 회원가입, 로그인 등 사용자 인증 관련 작업에 사용되며,
클라이언트에는 토큰만을 저장하면서 서버와의 무상태성을 구현할 수 있다.

순서
사용자가 회원가입을 하면서 서버의 DB에 사용자의 정보가 저장됨
사용자가 로그인하면 클라이언트가 로그인한 정보(아이디, 비밀번호 등)를 서버로 보냄
서버에서는 받은 정보를 DB와 비교해서 일치하면 Access token(JWT 토큰)을 생성하여 발급
클라이언트에서는 발급받은 토큰을 로컬스토리지 등에 저장
이후 서버에게 요청을 보낼 때 서버한테서 받은 토큰을 헤더에 담아서 함께 보냄
서버에서는 토큰의 유효기간과 토큰의 '서명'부분을 확인하여 사용자 정보를 인증한 뒤 요청받은 정보를 클라이언트에게 보냄

이렇게 하면 사용자의 정보를 서버에 저장할 필요가 없게 된다.
모든 정보는 토큰 안에 들어있고,
토큰은 클라이언트 측에 저장되기 때문에 서버에서 사용자의 정보를 따로 관리할 필요가 없다.
=> 무상태성 구현

토큰의 구조
토큰의 맨 뒤에 붙는 '서명'을 통해
특정 사용자의 정보를 기반으로 생성되었음을 증명 가능

\*\* json 토큰생성 사이트: https://jwt.io

Refresh 토큰
출처: https://velog.io/@daybreak/Access-Token-Refresh-Token

Access Token은 유효기간이 짧으면 사용자가 로그인을 자주 해서
매번 새로운 토큰을 발급받아야 하는 불편함이 있다.
하지만 그렇다고 토큰의 유효기간을 늘리면 해킹당할 가능성이 높아진다.

이러한 점들을 보완하는게 Refresh Token이다.

특징:
refresh token은 처음에 로그인을 완료했을 때 access token과 동시에 발급된다.

access token보다 긴 유효기간을 가지고,
access token이 만료되었을 때 새로운 access token이 발급될 수 있는 수단이 된다.

회사마다 정책이 다르다.
예를 들어 Refresh 토큰의 유효기간이 90일이라고 한다면,
사용자에게 '석달에 1번은 로그인하라' 는 의미가 된다.

Refresh 토큰은 Access 토큰이 만료된 후
(access 토큰이 없는 상황에서) 유저를 확인하기 위한 기준, '통행증'으로 사용되며,
access 토큰과 마찬가지로 '유효기간'이 지나면 만료된다.
(이후 새로운 Refresh 토큰 발급)

장점:

1. refresh token 덕분에 access token의 유효기간을 짧게 해둘 수 있다. (= 더 안전)

2. refresh token마저 만료되면 사용자는 새로 로그인을 해야 하지만 그 전까지는 로그인을 안 해도 된다. (= access token 만료 때마다 새로 로그인하지 않아도 됨)

유의점:
\*\* refresh token도 해킹될 가능성은 있기 때문에 적절한 유효기간 설정이 필요하다.
